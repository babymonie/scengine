var tt=(a,t)=>()=>(t||a((t={exports:{}}).exports,t),t.exports);var J=tt(L=>{"use strict";Object.defineProperty(L,"__esModule",{value:!0});L.LRUCache=void 0;var F=typeof performance=="object"&&performance&&typeof performance.now=="function"?performance:Date,$=new Set,U=typeof process=="object"&&process?process:{},V=(a,t,e,s)=>{typeof U.emitWarning=="function"?U.emitWarning(a,t,e,s):console.error(`[${e}] ${t}: ${a}`)},v=globalThis.AbortController,H=globalThis.AbortSignal,q;if(typeof v>"u"){H=class{onabort;_onabort=[];reason;aborted=!1;addEventListener(s,i){this._onabort.push(i)}},v=class{constructor(){t()}signal=new H;abort(s){var i,n;if(!this.signal.aborted){this.signal.reason=s,this.signal.aborted=!0;for(let r of this.signal._onabort)r(s);(n=(i=this.signal).onabort)==null||n.call(i,s)}}};let a=((q=U.env)==null?void 0:q.LRU_CACHE_IGNORE_AC_WARNING)!=="1",t=()=>{a&&(a=!1,V("AbortController is not defined. If using lru-cache in node 14, load an AbortController polyfill from the `node-abort-controller` package. A minimal polyfill is provided for use by LRUCache.fetch(), but it should not be relied upon in other contexts (eg, passing it to other APIs that use AbortController/AbortSignal might have undesirable effects). You may disable this with LRU_CACHE_IGNORE_AC_WARNING=1 in the env.","NO_ABORT_CONTROLLER","ENOTSUP",t))}}var et=a=>!$.has(a),wt=Symbol("type"),T=a=>a&&a===Math.floor(a)&&a>0&&isFinite(a),B=a=>T(a)?a<=Math.pow(2,8)?Uint8Array:a<=Math.pow(2,16)?Uint16Array:a<=Math.pow(2,32)?Uint32Array:a<=Number.MAX_SAFE_INTEGER?E:null:null,E=class extends Array{constructor(t){super(t),this.fill(0)}},k=class a{heap;length;static#l=!1;static create(t){let e=B(t);if(!e)return[];a.#l=!0;let s=new a(t,e);return a.#l=!1,s}constructor(t,e){if(!a.#l)throw new TypeError("instantiate Stack using Stack.create(n)");this.heap=new e(t),this.length=0}push(t){this.heap[this.length++]=t}pop(){return this.heap[--this.length]}},j=class a{#l;#f;#p;#m;#R;#v;ttl;ttlResolution;ttlAutopurge;updateAgeOnGet;updateAgeOnHas;allowStale;noDisposeOnSet;noUpdateTTL;maxEntrySize;sizeCalculation;noDeleteOnFetchRejection;noDeleteOnStaleGet;allowStaleOnFetchAbort;allowStaleOnFetchRejection;ignoreFetchAbort;#n;#w;#s;#i;#t;#h;#u;#a;#r;#y;#o;#b;#S;#d;#_;#E;#c;static unsafeExposeInternals(t){return{starts:t.#S,ttls:t.#d,sizes:t.#b,keyMap:t.#s,keyList:t.#i,valList:t.#t,next:t.#h,prev:t.#u,get head(){return t.#a},get tail(){return t.#r},free:t.#y,isBackgroundFetch:e=>t.#e(e),backgroundFetch:(e,s,i,n)=>t.#I(e,s,i,n),moveToTail:e=>t.#z(e),indexes:e=>t.#A(e),rindexes:e=>t.#x(e),isStale:e=>t.#g(e)}}get max(){return this.#l}get maxSize(){return this.#f}get calculatedSize(){return this.#w}get size(){return this.#n}get fetchMethod(){return this.#R}get memoMethod(){return this.#v}get dispose(){return this.#p}get disposeAfter(){return this.#m}constructor(t){let{max:e=0,ttl:s,ttlResolution:i=1,ttlAutopurge:n,updateAgeOnGet:r,updateAgeOnHas:l,allowStale:o,dispose:h,disposeAfter:f,noDisposeOnSet:c,noUpdateTTL:m,maxSize:w=0,maxEntrySize:g=0,sizeCalculation:d,fetchMethod:p,memoMethod:u,noDeleteOnFetchRejection:y,noDeleteOnStaleGet:S,allowStaleOnFetchRejection:b,allowStaleOnFetchAbort:_,ignoreFetchAbort:O}=t;if(e!==0&&!T(e))throw new TypeError("max option must be a nonnegative integer");let x=e?B(e):Array;if(!x)throw new Error("invalid max value: "+e);if(this.#l=e,this.#f=w,this.maxEntrySize=g||this.#f,this.sizeCalculation=d,this.sizeCalculation){if(!this.#f&&!this.maxEntrySize)throw new TypeError("cannot set sizeCalculation without setting maxSize or maxEntrySize");if(typeof this.sizeCalculation!="function")throw new TypeError("sizeCalculation set to non-function")}if(u!==void 0&&typeof u!="function")throw new TypeError("memoMethod must be a function if defined");if(this.#v=u,p!==void 0&&typeof p!="function")throw new TypeError("fetchMethod must be a function if specified");if(this.#R=p,this.#E=!!p,this.#s=new Map,this.#i=new Array(e).fill(void 0),this.#t=new Array(e).fill(void 0),this.#h=new x(e),this.#u=new x(e),this.#a=0,this.#r=0,this.#y=k.create(e),this.#n=0,this.#w=0,typeof h=="function"&&(this.#p=h),typeof f=="function"?(this.#m=f,this.#o=[]):(this.#m=void 0,this.#o=void 0),this.#_=!!this.#p,this.#c=!!this.#m,this.noDisposeOnSet=!!c,this.noUpdateTTL=!!m,this.noDeleteOnFetchRejection=!!y,this.allowStaleOnFetchRejection=!!b,this.allowStaleOnFetchAbort=!!_,this.ignoreFetchAbort=!!O,this.maxEntrySize!==0){if(this.#f!==0&&!T(this.#f))throw new TypeError("maxSize must be a positive integer if specified");if(!T(this.maxEntrySize))throw new TypeError("maxEntrySize must be a positive integer if specified");this.#N()}if(this.allowStale=!!o,this.noDeleteOnStaleGet=!!S,this.updateAgeOnGet=!!r,this.updateAgeOnHas=!!l,this.ttlResolution=T(i)||i===0?i:1,this.ttlAutopurge=!!n,this.ttl=s||0,this.ttl){if(!T(this.ttl))throw new TypeError("ttl must be a positive integer if specified");this.#D()}if(this.#l===0&&this.ttl===0&&this.#f===0)throw new TypeError("At least one of max, maxSize, or ttl is required");if(!this.ttlAutopurge&&!this.#l&&!this.#f){let R="LRU_CACHE_UNBOUNDED";et(R)&&($.add(R),V("TTL caching without ttlAutopurge, max, or maxSize can result in unbounded memory consumption.","UnboundedCacheWarning",R,a))}}getRemainingTTL(t){return this.#s.has(t)?1/0:0}#D(){let t=new E(this.#l),e=new E(this.#l);this.#d=t,this.#S=e,this.#U=(n,r,l=F.now())=>{if(e[n]=r!==0?l:0,t[n]=r,r!==0&&this.ttlAutopurge){let o=setTimeout(()=>{this.#g(n)&&this.#T(this.#i[n],"expire")},r+1);o.unref&&o.unref()}},this.#O=n=>{e[n]=t[n]!==0?F.now():0},this.#F=(n,r)=>{if(t[r]){let l=t[r],o=e[r];if(!l||!o)return;n.ttl=l,n.start=o,n.now=s||i();let h=n.now-o;n.remainingTTL=l-h}};let s=0,i=()=>{let n=F.now();if(this.ttlResolution>0){s=n;let r=setTimeout(()=>s=0,this.ttlResolution);r.unref&&r.unref()}return n};this.getRemainingTTL=n=>{let r=this.#s.get(n);if(r===void 0)return 0;let l=t[r],o=e[r];if(!l||!o)return 1/0;let h=(s||i())-o;return l-h},this.#g=n=>{let r=e[n],l=t[n];return!!l&&!!r&&(s||i())-r>l}}#O=()=>{};#F=()=>{};#U=()=>{};#g=()=>!1;#N(){let t=new E(this.#l);this.#w=0,this.#b=t,this.#C=e=>{this.#w-=t[e],t[e]=0},this.#k=(e,s,i,n)=>{if(this.#e(s))return 0;if(!T(i))if(n){if(typeof n!="function")throw new TypeError("sizeCalculation must be a function");if(i=n(s,e),!T(i))throw new TypeError("sizeCalculation return invalid (expect positive integer)")}else throw new TypeError("invalid size value (must be positive integer). When maxSize or maxEntrySize is used, sizeCalculation or size must be set.");return i},this.#L=(e,s,i)=>{if(t[e]=s,this.#f){let n=this.#f-t[e];for(;this.#w>n;)this.#W(!0)}this.#w+=t[e],i&&(i.entrySize=s,i.totalCalculatedSize=this.#w)}}#C=t=>{};#L=(t,e,s)=>{};#k=(t,e,s,i)=>{if(s||i)throw new TypeError("cannot set size without setting maxSize or maxEntrySize on cache");return 0};*#A({allowStale:t=this.allowStale}={}){if(this.#n)for(let e=this.#r;!(!this.#j(e)||((t||!this.#g(e))&&(yield e),e===this.#a));)e=this.#u[e]}*#x({allowStale:t=this.allowStale}={}){if(this.#n)for(let e=this.#a;!(!this.#j(e)||((t||!this.#g(e))&&(yield e),e===this.#r));)e=this.#h[e]}#j(t){return t!==void 0&&this.#s.get(this.#i[t])===t}*entries(){for(let t of this.#A())this.#t[t]!==void 0&&this.#i[t]!==void 0&&!this.#e(this.#t[t])&&(yield[this.#i[t],this.#t[t]])}*rentries(){for(let t of this.#x())this.#t[t]!==void 0&&this.#i[t]!==void 0&&!this.#e(this.#t[t])&&(yield[this.#i[t],this.#t[t]])}*keys(){for(let t of this.#A()){let e=this.#i[t];e!==void 0&&!this.#e(this.#t[t])&&(yield e)}}*rkeys(){for(let t of this.#x()){let e=this.#i[t];e!==void 0&&!this.#e(this.#t[t])&&(yield e)}}*values(){for(let t of this.#A())this.#t[t]!==void 0&&!this.#e(this.#t[t])&&(yield this.#t[t])}*rvalues(){for(let t of this.#x())this.#t[t]!==void 0&&!this.#e(this.#t[t])&&(yield this.#t[t])}[Symbol.iterator](){return this.entries()}[Symbol.toStringTag]="LRUCache";find(t,e={}){for(let s of this.#A()){let i=this.#t[s],n=this.#e(i)?i.__staleWhileFetching:i;if(n!==void 0&&t(n,this.#i[s],this))return this.get(this.#i[s],e)}}forEach(t,e=this){for(let s of this.#A()){let i=this.#t[s],n=this.#e(i)?i.__staleWhileFetching:i;n!==void 0&&t.call(e,n,this.#i[s],this)}}rforEach(t,e=this){for(let s of this.#x()){let i=this.#t[s],n=this.#e(i)?i.__staleWhileFetching:i;n!==void 0&&t.call(e,n,this.#i[s],this)}}purgeStale(){let t=!1;for(let e of this.#x({allowStale:!0}))this.#g(e)&&(this.#T(this.#i[e],"expire"),t=!0);return t}info(t){let e=this.#s.get(t);if(e===void 0)return;let s=this.#t[e],i=this.#e(s)?s.__staleWhileFetching:s;if(i===void 0)return;let n={value:i};if(this.#d&&this.#S){let r=this.#d[e],l=this.#S[e];if(r&&l){let o=r-(F.now()-l);n.ttl=o,n.start=Date.now()}}return this.#b&&(n.size=this.#b[e]),n}dump(){let t=[];for(let e of this.#A({allowStale:!0})){let s=this.#i[e],i=this.#t[e],n=this.#e(i)?i.__staleWhileFetching:i;if(n===void 0||s===void 0)continue;let r={value:n};if(this.#d&&this.#S){r.ttl=this.#d[e];let l=F.now()-this.#S[e];r.start=Math.floor(Date.now()-l)}this.#b&&(r.size=this.#b[e]),t.unshift([s,r])}return t}load(t){this.clear();for(let[e,s]of t){if(s.start){let i=Date.now()-s.start;s.start=F.now()-i}this.set(e,s.value,s)}}set(t,e,s={}){var m,w,g,d,p;if(e===void 0)return this.delete(t),this;let{ttl:i=this.ttl,start:n,noDisposeOnSet:r=this.noDisposeOnSet,sizeCalculation:l=this.sizeCalculation,status:o}=s,{noUpdateTTL:h=this.noUpdateTTL}=s,f=this.#k(t,e,s.size||0,l);if(this.maxEntrySize&&f>this.maxEntrySize)return o&&(o.set="miss",o.maxEntrySizeExceeded=!0),this.#T(t,"set"),this;let c=this.#n===0?void 0:this.#s.get(t);if(c===void 0)c=this.#n===0?this.#r:this.#y.length!==0?this.#y.pop():this.#n===this.#l?this.#W(!1):this.#n,this.#i[c]=t,this.#t[c]=e,this.#s.set(t,c),this.#h[this.#r]=c,this.#u[c]=this.#r,this.#r=c,this.#n++,this.#L(c,f,o),o&&(o.set="add"),h=!1;else{this.#z(c);let u=this.#t[c];if(e!==u){if(this.#E&&this.#e(u)){u.__abortController.abort(new Error("replaced"));let{__staleWhileFetching:y}=u;y!==void 0&&!r&&(this.#_&&((m=this.#p)==null||m.call(this,y,t,"set")),this.#c&&((w=this.#o)==null||w.push([y,t,"set"])))}else r||(this.#_&&((g=this.#p)==null||g.call(this,u,t,"set")),this.#c&&((d=this.#o)==null||d.push([u,t,"set"])));if(this.#C(c),this.#L(c,f,o),this.#t[c]=e,o){o.set="replace";let y=u&&this.#e(u)?u.__staleWhileFetching:u;y!==void 0&&(o.oldValue=y)}}else o&&(o.set="update")}if(i!==0&&!this.#d&&this.#D(),this.#d&&(h||this.#U(c,i,n),o&&this.#F(o,c)),!r&&this.#c&&this.#o){let u=this.#o,y;for(;y=u==null?void 0:u.shift();)(p=this.#m)==null||p.call(this,...y)}return this}pop(){var t;try{for(;this.#n;){let e=this.#t[this.#a];if(this.#W(!0),this.#e(e)){if(e.__staleWhileFetching)return e.__staleWhileFetching}else if(e!==void 0)return e}}finally{if(this.#c&&this.#o){let e=this.#o,s;for(;s=e==null?void 0:e.shift();)(t=this.#m)==null||t.call(this,...s)}}}#W(t){var n,r;let e=this.#a,s=this.#i[e],i=this.#t[e];return this.#E&&this.#e(i)?i.__abortController.abort(new Error("evicted")):(this.#_||this.#c)&&(this.#_&&((n=this.#p)==null||n.call(this,i,s,"evict")),this.#c&&((r=this.#o)==null||r.push([i,s,"evict"]))),this.#C(e),t&&(this.#i[e]=void 0,this.#t[e]=void 0,this.#y.push(e)),this.#n===1?(this.#a=this.#r=0,this.#y.length=0):this.#a=this.#h[e],this.#s.delete(s),this.#n--,e}has(t,e={}){let{updateAgeOnHas:s=this.updateAgeOnHas,status:i}=e,n=this.#s.get(t);if(n!==void 0){let r=this.#t[n];if(this.#e(r)&&r.__staleWhileFetching===void 0)return!1;if(this.#g(n))i&&(i.has="stale",this.#F(i,n));else return s&&this.#O(n),i&&(i.has="hit",this.#F(i,n)),!0}else i&&(i.has="miss");return!1}peek(t,e={}){let{allowStale:s=this.allowStale}=e,i=this.#s.get(t);if(i===void 0||!s&&this.#g(i))return;let n=this.#t[i];return this.#e(n)?n.__staleWhileFetching:n}#I(t,e,s,i){let n=e===void 0?void 0:this.#t[e];if(this.#e(n))return n;let r=new v,{signal:l}=s;l==null||l.addEventListener("abort",()=>r.abort(l.reason),{signal:r.signal});let o={signal:r.signal,options:s,context:i},h=(d,p=!1)=>{let{aborted:u}=r.signal,y=s.ignoreFetchAbort&&d!==void 0;if(s.status&&(u&&!p?(s.status.fetchAborted=!0,s.status.fetchError=r.signal.reason,y&&(s.status.fetchAbortIgnored=!0)):s.status.fetchResolved=!0),u&&!y&&!p)return c(r.signal.reason);let S=w;return this.#t[e]===w&&(d===void 0?S.__staleWhileFetching?this.#t[e]=S.__staleWhileFetching:this.#T(t,"fetch"):(s.status&&(s.status.fetchUpdated=!0),this.set(t,d,o.options))),d},f=d=>(s.status&&(s.status.fetchRejected=!0,s.status.fetchError=d),c(d)),c=d=>{let{aborted:p}=r.signal,u=p&&s.allowStaleOnFetchAbort,y=u||s.allowStaleOnFetchRejection,S=y||s.noDeleteOnFetchRejection,b=w;if(this.#t[e]===w&&(!S||b.__staleWhileFetching===void 0?this.#T(t,"fetch"):u||(this.#t[e]=b.__staleWhileFetching)),y)return s.status&&b.__staleWhileFetching!==void 0&&(s.status.returnedStale=!0),b.__staleWhileFetching;if(b.__returned===b)throw d},m=(d,p)=>{var y;let u=(y=this.#R)==null?void 0:y.call(this,t,n,o);u&&u instanceof Promise&&u.then(S=>d(S===void 0?void 0:S),p),r.signal.addEventListener("abort",()=>{(!s.ignoreFetchAbort||s.allowStaleOnFetchAbort)&&(d(void 0),s.allowStaleOnFetchAbort&&(d=S=>h(S,!0)))})};s.status&&(s.status.fetchDispatched=!0);let w=new Promise(m).then(h,f),g=Object.assign(w,{__abortController:r,__staleWhileFetching:n,__returned:void 0});return e===void 0?(this.set(t,g,{...o.options,status:void 0}),e=this.#s.get(t)):this.#t[e]=g,g}#e(t){if(!this.#E)return!1;let e=t;return!!e&&e instanceof Promise&&e.hasOwnProperty("__staleWhileFetching")&&e.__abortController instanceof v}async fetch(t,e={}){let{allowStale:s=this.allowStale,updateAgeOnGet:i=this.updateAgeOnGet,noDeleteOnStaleGet:n=this.noDeleteOnStaleGet,ttl:r=this.ttl,noDisposeOnSet:l=this.noDisposeOnSet,size:o=0,sizeCalculation:h=this.sizeCalculation,noUpdateTTL:f=this.noUpdateTTL,noDeleteOnFetchRejection:c=this.noDeleteOnFetchRejection,allowStaleOnFetchRejection:m=this.allowStaleOnFetchRejection,ignoreFetchAbort:w=this.ignoreFetchAbort,allowStaleOnFetchAbort:g=this.allowStaleOnFetchAbort,context:d,forceRefresh:p=!1,status:u,signal:y}=e;if(!this.#E)return u&&(u.fetch="get"),this.get(t,{allowStale:s,updateAgeOnGet:i,noDeleteOnStaleGet:n,status:u});let S={allowStale:s,updateAgeOnGet:i,noDeleteOnStaleGet:n,ttl:r,noDisposeOnSet:l,size:o,sizeCalculation:h,noUpdateTTL:f,noDeleteOnFetchRejection:c,allowStaleOnFetchRejection:m,allowStaleOnFetchAbort:g,ignoreFetchAbort:w,status:u,signal:y},b=this.#s.get(t);if(b===void 0){u&&(u.fetch="miss");let _=this.#I(t,b,S,d);return _.__returned=_}else{let _=this.#t[b];if(this.#e(_)){let G=s&&_.__staleWhileFetching!==void 0;return u&&(u.fetch="inflight",G&&(u.returnedStale=!0)),G?_.__staleWhileFetching:_.__returned=_}let O=this.#g(b);if(!p&&!O)return u&&(u.fetch="hit"),this.#z(b),i&&this.#O(b),u&&this.#F(u,b),_;let x=this.#I(t,b,S,d),D=x.__staleWhileFetching!==void 0&&s;return u&&(u.fetch=O?"stale":"refresh",D&&O&&(u.returnedStale=!0)),D?x.__staleWhileFetching:x.__returned=x}}async forceFetch(t,e={}){let s=await this.fetch(t,e);if(s===void 0)throw new Error("fetch() returned undefined");return s}memo(t,e={}){let s=this.#v;if(!s)throw new Error("no memoMethod provided to constructor");let{context:i,forceRefresh:n,...r}=e,l=this.get(t,r);if(!n&&l!==void 0)return l;let o=s(t,l,{options:r,context:i});return this.set(t,o,r),o}get(t,e={}){let{allowStale:s=this.allowStale,updateAgeOnGet:i=this.updateAgeOnGet,noDeleteOnStaleGet:n=this.noDeleteOnStaleGet,status:r}=e,l=this.#s.get(t);if(l!==void 0){let o=this.#t[l],h=this.#e(o);return r&&this.#F(r,l),this.#g(l)?(r&&(r.get="stale"),h?(r&&s&&o.__staleWhileFetching!==void 0&&(r.returnedStale=!0),s?o.__staleWhileFetching:void 0):(n||this.#T(t,"expire"),r&&s&&(r.returnedStale=!0),s?o:void 0)):(r&&(r.get="hit"),h?o.__staleWhileFetching:(this.#z(l),i&&this.#O(l),o))}else r&&(r.get="miss")}#P(t,e){this.#u[e]=t,this.#h[t]=e}#z(t){t!==this.#r&&(t===this.#a?this.#a=this.#h[t]:this.#P(this.#u[t],this.#h[t]),this.#P(this.#r,t),this.#r=t)}delete(t){return this.#T(t,"delete")}#T(t,e){var i,n,r,l;let s=!1;if(this.#n!==0){let o=this.#s.get(t);if(o!==void 0)if(s=!0,this.#n===1)this.#M(e);else{this.#C(o);let h=this.#t[o];if(this.#e(h)?h.__abortController.abort(new Error("deleted")):(this.#_||this.#c)&&(this.#_&&((i=this.#p)==null||i.call(this,h,t,e)),this.#c&&((n=this.#o)==null||n.push([h,t,e]))),this.#s.delete(t),this.#i[o]=void 0,this.#t[o]=void 0,o===this.#r)this.#r=this.#u[o];else if(o===this.#a)this.#a=this.#h[o];else{let f=this.#u[o];this.#h[f]=this.#h[o];let c=this.#h[o];this.#u[c]=this.#u[o]}this.#n--,this.#y.push(o)}}if(this.#c&&((r=this.#o)!=null&&r.length)){let o=this.#o,h;for(;h=o==null?void 0:o.shift();)(l=this.#m)==null||l.call(this,...h)}return s}clear(){return this.#M("delete")}#M(t){var e,s,i;for(let n of this.#x({allowStale:!0})){let r=this.#t[n];if(this.#e(r))r.__abortController.abort(new Error("deleted"));else{let l=this.#i[n];this.#_&&((e=this.#p)==null||e.call(this,r,l,t)),this.#c&&((s=this.#o)==null||s.push([r,l,t]))}}if(this.#s.clear(),this.#t.fill(void 0),this.#i.fill(void 0),this.#d&&this.#S&&(this.#d.fill(0),this.#S.fill(0)),this.#b&&this.#b.fill(0),this.#a=0,this.#r=0,this.#y.length=0,this.#w=0,this.#n=0,this.#c&&this.#o){let n=this.#o,r;for(;r=n==null?void 0:n.shift();)(i=this.#m)==null||i.call(this,...r)}}};L.LRUCache=j});var it=require("axios"),st=require("fs"),K=require("cheerio"),{URL:nt}=require("url"),rt=require("puppeteer"),{LRUCache:ot}=J(),at=require("crypto"),N=1e3*60*5,X=new ot({max:100,ttl:N}),Y=new Map;function lt(a){return X.get(a)}function ht(a,t,e=N){X.set(a,t,{ttl:e})}function ct(a){return at.createHash("md5").update(a).digest("hex")}function ft(a,t){return`${a}::${t}`}async function W(a,t,e={},s=N){let i=ft(a,t),n=lt(i);if(n)return n;let r=await it.get(a,e);return ht(i,r.data,s),r.data}var A={trim:(a,t)=>typeof a=="string"?a.trim():a,toLowerCase:(a,t)=>typeof a=="string"?a.toLowerCase():a,toUpperCase:(a,t)=>typeof a=="string"?a.toUpperCase():a,default:(a,t,e)=>a==null||a===""?e:a,regex:(a,t,e,s="0")=>{if(typeof a!="string")return a;let i=new RegExp(e),n=a.match(i);if(n){let r=parseInt(s);return n[r]||a}return a},dateParse:(a,t)=>{let e=new Date(a);return isNaN(e.getTime())?a:e.toISOString()},customJS:(a,t,e)=>{try{return new Function("value",e)(a)}catch{return a}},regexReplace:(a,t,e,s)=>{if(typeof a!="string")return a;e=e.replace(/\\\\/g,"\\");let i=Y.get(e);return i||(i=new RegExp(e),Y.set(e,i)),a.replace(i,s)}};function M(a,t){if(Array.isArray(a))return a.map(e=>M(e,t));if(typeof a=="object"&&a!==null){if(a.type&&a.children)return t(a).text();let e={};for(let s in a)e[s]=M(a[s],t);return e}else return a}function P(a,t){let e=[],s=1,i=t;for(;i<a.length&&s>0;){let n=a[i];n.endsWith("{")?(s++,e.push(n)):n==="}"?(s--,s>0&&e.push(n)):e.push(n),i++}return{blockText:e.join(`
`),newIndex:i}}function Q(a){a=a.trim();let t=a.match(/^([^\{]+)\{([\s\S]+)\}\s*$/);if(!t)throw new Error("Invalid script format. Ensure the Scengine is enclosed in { }.");let e=t[1].trim().split("|").map(l=>l.trim()),s=e[0],i={};for(let l=1;l<e.length;l++){let[o,h]=e[l].split("=");o&&h&&(i[o.trim()]=h.trim())}let n=t[2].trim(),r=C(n);return{url:s,config:i,instructions:r}}function C(a){a=a.replace(/}\s*else\s*{/g,`}
else {`);let t=a.split(`
`).map(i=>i.trim()).filter(i=>i&&!i.startsWith("//")),e=[],s=0;for(;s<t.length;){let i=t[s];if(/^if\s*\(.*\)\s*\{$/.test(i)){let n=i.match(/^if\s*\((.*)\)\s*\{$/);if(!n)throw new Error(`Invalid if condition: ${i}`);let r=n[1];s++;let{blockText:l,newIndex:o}=P(t,s),h=C(l);s=o;let f=null;if(s<t.length&&/^else\s*\{$/.test(t[s])){s++;let{blockText:c,newIndex:m}=P(t,s);f=C(c),s=m}e.push({type:"conditional",condition:r,ifInstructions:h,elseInstructions:f});continue}if(i.endsWith(":{")){let n=i.slice(0,-2).trim();s++;let{blockText:r,newIndex:l}=P(t,s),o=C(r);e.push({type:"block",assign:n,instructions:o}),s=l;continue}{let n=!1;i.startsWith("!")&&(n=!0,i=i.slice(1).trim());let r=i.split("=");if(r.length!==2)throw new Error(`Invalid instruction: ${i}`);let l=r[0].trim(),o=r[1].trim(),h,f=[];if(o.includes("|")){let g=o.split("|").map(d=>d.trim());h=g[0],f=g.slice(1).map(d=>{let p=d.match(/^(\w+)(?:\((.*)\))?$/);return p?{fn:p[1],params:p[2]?p[2].split(",").map(u=>u.trim().replace(/^["']|["']$/g,"")):[]}:{fn:d,params:[]}})}else h=o;let c=null;(l.startsWith('"')&&l.endsWith('"')||l.startsWith("'")&&l.endsWith("'"))&&(c=l.slice(1,-1));let m=null,w=null;if(!c){let g=l.split(">").map(p=>p.trim());m=g.map(p=>p.includes("..")?p.replace(/\.\./g,"."):p);let d=g[g.length-1];if(!d.startsWith(".")&&d.includes(".")){let p=d.split(".");m[m.length-1]=p[0].trim(),w=p[1].trim()}}c!==null?e.push({type:"literal",literal:c,assign:h,transforms:f,exclude:n}):e.push({type:"extract",exclude:n,chain:m,attribute:w,assign:h,transforms:f}),s++}}return e}async function z(a,t,e,s){t._excluded||(t._excluded={});for(let i of a)if(i.type==="extract"){let n=i.chain[0],r;s?r=s:t[n]?r=t[n]:r=e(n).toArray();for(let l=1;l<i.chain.length;l++){let o=i.chain[l],h=[];for(let f of r)h=h.concat(e(f).find(o).toArray());r=h}i.attribute&&(r=r.map(l=>e(l).attr(i.attribute))),i.transforms&&i.transforms.length>0&&(r=r.map(l=>{let o=l;for(let{fn:h,params:f}of i.transforms)typeof A[h]=="function"&&(o=A[h](o,e,...f));return o})),t[i.assign]=r,i.exclude&&(t._excluded[i.assign]=!0)}else if(i.type==="literal"){let n=i.literal;if(i.transforms&&i.transforms.length>0)for(let{fn:r,params:l}of i.transforms)typeof A[r]=="function"&&(n=A[r](n,e,...l));t[i.assign]=[n],i.exclude&&(t._excluded[i.assign]=!0)}else if(i.type==="block"){let n={};n._excluded={};let r=null;for(let o of i.instructions)if(o.type==="extract"||o.type==="literal"){let h;if(o.type==="extract"){let f=o.chain[0];n[f]?h=n[f]:t[f]?h=t[f]:h=e(f).toArray();for(let c=1;c<o.chain.length;c++){let m=o.chain[c],w=[];for(let g of h)w=w.concat(e(g).find(m).toArray());h=w}o.attribute&&(h=h.map(c=>e(c).attr(o.attribute))),o.transforms&&o.transforms.length>0&&(h=h.map(c=>{let m=c;for(let{fn:w,params:g}of o.transforms)typeof A[w]=="function"&&(m=A[w](m,e,...g));return m})),n[o.assign]=h}else if(o.type==="literal"){let f=o.literal;if(o.transforms&&o.transforms.length>0)for(let{fn:c,params:m}of o.transforms)typeof A[c]=="function"&&(f=A[c](f,e,...m));n[o.assign]=[f]}o.exclude&&(n._excluded[o.assign]=!0),r||(r=n[o.assign])}else if(o.type==="block"){let h=await z(o.instructions,n,e,null);n[o.assign]=h}let l=[];if(r&&Array.isArray(r))for(let o=0;o<r.length;o++){let h={};for(let f in n){if(f==="_excluded"||n._excluded&&n._excluded[f])continue;let c=n[f];h[f]=Array.isArray(c)?c[o]:c}l.push(h)}else l=n;t[i.assign]=l}else if(i.type==="conditional"){let n=!1;try{n=new Function("context","$","return ("+i.condition+");")(t,e)}catch{n=!1}n?await z(i.ifInstructions,t,e,s):i.elseInstructions&&await z(i.elseInstructions,t,e,s)}return t}function I(a){let t={};for(let e of a)for(let s in e){if(s==="_excluded"){t._excluded||(t._excluded={}),Object.assign(t._excluded,e._excluded);continue}Array.isArray(e[s])?(t[s]||(t[s]=[]),t[s]=t[s].concat(e[s])):(t[s]||(t[s]=[]),t[s].push(e[s]))}return t}var ut={};function dt(a){if(a.engines)for(let t in a.engines)ut[t]=a.engines[t];if(a.transformFunctions)for(let t in a.transformFunctions)A[t]=a.transformFunctions[t]}async function Z(a,t={}){var o;let e=ct(a),{url:s,config:i,instructions:n}=Q(a);s=s.replace(/\[(\w+)\]/g,(h,f)=>t[f]!==void 0?encodeURIComponent(t[f]):"");let r={},l=async h=>{let f=K.load(h),c={};return await z(n,c,f,null),M(c,f)};if(i.engine&&i.engine.toLowerCase()==="puppeteer"){let h;try{h=await rt.launch();let f=await h.newPage();if(await f.goto(s,{waitUntil:"networkidle2"}),((o=i.paginationType)==null?void 0:o.toLowerCase())==="scroll"){let c=[],m=i.paginationLimit?parseInt(i.paginationLimit):5;for(let w=0;w<m;w++){await f.evaluate(()=>window.scrollBy(0,window.innerHeight)),await f.waitForTimeout(1e3);let g=await f.content();c.push(await l(g))}r=I(c)}else if(r=await l(await f.content()),i.paginationNext){let c=1,m=i.paginationLimit?parseInt(i.paginationLimit):5,w=i.paginationNext;for(;c<m;){let g=await f.$(w);if(!g)break;let d=await f.evaluate(u=>u.href,g);await f.goto(d,{waitUntil:"networkidle2"});let p=await l(await f.content());r=I([r,p]),c++}}}finally{h&&await h.close()}return{result:r,config:i}}else{let h=await W(s,e);r=await l(h);let f=K.load(h);if(i.paginationAjax){let c=i.paginationLimit?parseInt(i.paginationLimit):5,m=[];if((i.concurrency?parseInt(i.concurrency):1)>1){let g=Array.from({length:c},(p,u)=>W(i.paginationAjax.replace("{page}",u+1),e)),d=await Promise.all(g);m=await Promise.all(d.map(l))}else for(let g=1;g<=c;g++){let d=await W(i.paginationAjax.replace("{page}",g),e);m.push(await l(d))}r=I(m)}else if(i.paginationNext){let c=1,m=i.paginationLimit?parseInt(i.paginationLimit):5,w=i.paginationNext;for(;c<m;){let g=f(w).first();if(!g||!g.attr("href"))break;let d=new nt(g.attr("href"),s).toString(),p=await W(d,e),u=await l(p);r=I([r,u]),c++}}return{result:r,config:i}}}module.exports={scrape:Z,parseScript:Q,parseInstructions:C,executeInstructions:z,transformFunctions:A,registerPlugin:dt};if(require.main===module){process.argv.length<3&&(console.error("Usage: node index.js <script_file> [prop1=val1 prop2=val2 ...]"),process.exit(1));let a=st.readFileSync(process.argv[2],"utf8"),t={};if(process.argv.length>3)for(let e=3;e<process.argv.length;e++){let[s,i]=process.argv[e].split("=");t[s]=i}Z(a,t).then(e=>{console.log(JSON.stringify(e,null,2))}).catch(e=>{console.error(e)})}
//# sourceMappingURL=scengine.cjs.map
