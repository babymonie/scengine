var y=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(n,i)=>(typeof require<"u"?require:n)[i]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});var j=(t,n)=>()=>(n||t((n={exports:{}}).exports,n),n.exports);var B=j((M,R)=>{var F=y("axios"),U=y("fs"),T=y("cheerio"),{URL:E}=y("url"),N=y("crypto"),C=new Map,P=1e3*60*5;function q(t){return N.createHash("md5").update(t).digest("hex")}function $(t,n){return`${t}::${n}`}function D(t){let n=C.get(t);return n?Date.now()>n.expireAt?(C.delete(t),null):n.data:null}function H(t,n,i=P){C.set(t,{data:n,expireAt:Date.now()+i})}async function I(t,n,i={},s=P){let e=$(t,n),a=D(e);if(a)return a;let l=await F.get(t,i);return H(e,l.data,s),l.data}var w={trim:(t,n)=>typeof t=="string"?t.trim():t,toLowerCase:(t,n)=>typeof t=="string"?t.toLowerCase():t,toUpperCase:(t,n)=>typeof t=="string"?t.toUpperCase():t,default:(t,n,i)=>t==null||t===""?i:t,regex:(t,n,i,s="0")=>{if(typeof t!="string")return t;let e=new RegExp(i),a=t.match(e);if(a){let l=parseInt(s);return a[l]||t}return t},dateParse:(t,n)=>{let i=new Date(t);return isNaN(i.getTime())?t:i.toISOString()},customJS:(t,n,i)=>{try{return new Function("value",i)(t)}catch{return t}},regexReplace:(t,n,i,s)=>{if(typeof t!="string")return t;i=i.replace(/\\\\/g,"\\");let e=new RegExp(i);return t.replace(e,s)}};function L(t,n){if(Array.isArray(t))return t.map(i=>L(i,n));if(typeof t=="object"&&t!==null){if(t.type&&t.children)return n(t).text();let i={};for(let s in t)i[s]=L(t[s],n);return i}else return t}function A(t,n){let i=[],s=1,e=n;for(;e<t.length&&s>0;){let a=t[e];a.endsWith("{")?(s++,i.push(a)):a==="}"?(s--,s>0&&i.push(a)):i.push(a),e++}return{blockText:i.join(`
`),newIndex:e}}function S(t){t=t.trim();let n=t.match(/^([^\{]+)\{([\s\S]+)\}\s*$/);if(!n)throw new Error("Invalid script format. Ensure the Scengine is enclosed in { }.");let i=n[1].trim().split("|").map(f=>f.trim()),s=i[0],e={};for(let f=1;f<i.length;f++){let[r,o]=i[f].split("=");r&&o&&(e[r.trim()]=o.trim())}let a=n[2].trim(),l=x(a);return{url:s,config:e,instructions:l}}function x(t){t=t.replace(/}\s*else\s*{/g,`}
else {`);let n=t.split(`
`).map(e=>e.trim()).filter(e=>e&&!e.startsWith("//")),i=[],s=0;for(;s<n.length;){let e=n[s];if(/^if\s*\(.*\)\s*\{$/.test(e)){let a=e.match(/^if\s*\((.*)\)\s*\{$/);if(!a)throw new Error(`Invalid if condition: ${e}`);let l=a[1];s++;let{blockText:f,newIndex:r}=A(n,s),o=x(f);s=r;let c=null;if(s<n.length&&/^else\s*\{$/.test(n[s])){s++;let{blockText:u,newIndex:g}=A(n,s);c=x(u),s=g}i.push({type:"conditional",condition:l,ifInstructions:o,elseInstructions:c});continue}if(e.endsWith(":{")){let a=e.slice(0,-2).trim();s++;let{blockText:l,newIndex:f}=A(n,s),r=x(l);i.push({type:"block",assign:a,instructions:r}),s=f;continue}{let a=!1;e.startsWith("!")&&(a=!0,e=e.slice(1).trim());let l=e.split("=");if(l.length!==2)throw new Error(`Invalid instruction: ${e}`);let f=l[0].trim(),r=l[1].trim(),o,c=[];if(r.includes("|")){let h=r.split("|").map(d=>d.trim());o=h[0],c=h.slice(1).map(d=>{let m=d.match(/^(\w+)(?:\((.*)\))?$/);return m?{fn:m[1],params:m[2]?m[2].split(",").map(W=>W.trim().replace(/^["']|["']$/g,"")):[]}:{fn:d,params:[]}})}else o=r;let u=null;(f.startsWith('"')&&f.endsWith('"')||f.startsWith("'")&&f.endsWith("'"))&&(u=f.slice(1,-1));let g=null,p=null;if(!u){let h=f.split(">").map(m=>m.trim());g=h.map(m=>m.includes("..")?m.replace(/\.\./g,"."):m);let d=h[h.length-1];if(!d.startsWith(".")&&d.includes(".")){let m=d.split(".");g[g.length-1]=m[0].trim(),p=m[1].trim()}}u!==null?i.push({type:"literal",literal:u,assign:o,transforms:c,exclude:a}):i.push({type:"extract",exclude:a,chain:g,attribute:p,assign:o,transforms:c}),s++}}return i}async function k(t,n,i,s){n._excluded||(n._excluded={});for(let e of t)if(e.type==="extract"){let a=e.chain[0],l;s?l=s:n[a]?l=n[a]:l=i(a).toArray();for(let f=1;f<e.chain.length;f++){let r=e.chain[f],o=[];for(let c of l)o=o.concat(i(c).find(r).toArray());l=o}e.attribute&&(l=l.map(f=>i(f).attr(e.attribute))),e.transforms&&e.transforms.length>0&&(l=l.map(f=>{let r=f;for(let{fn:o,params:c}of e.transforms)typeof w[o]=="function"&&(r=w[o](r,i,...c));return r})),n[e.assign]=l,e.exclude&&(n._excluded[e.assign]=!0)}else if(e.type==="literal"){let a=e.literal;if(e.transforms&&e.transforms.length>0)for(let{fn:l,params:f}of e.transforms)typeof w[l]=="function"&&(a=w[l](a,i,...f));n[e.assign]=[a],e.exclude&&(n._excluded[e.assign]=!0)}else if(e.type==="block"){let a={};a._excluded={};let l=null;for(let r of e.instructions)if(r.type==="extract"||r.type==="literal"){let o;if(r.type==="extract"){let c=r.chain[0];a[c]?o=a[c]:n[c]?o=n[c]:o=i(c).toArray();for(let u=1;u<r.chain.length;u++){let g=r.chain[u],p=[];for(let h of o)p=p.concat(i(h).find(g).toArray());o=p}r.attribute&&(o=o.map(u=>i(u).attr(r.attribute))),r.transforms&&r.transforms.length>0&&(o=o.map(u=>{let g=u;for(let{fn:p,params:h}of r.transforms)typeof w[p]=="function"&&(g=w[p](g,i,...h));return g})),a[r.assign]=o}else if(r.type==="literal"){let c=r.literal;if(r.transforms&&r.transforms.length>0)for(let{fn:u,params:g}of r.transforms)typeof w[u]=="function"&&(c=w[u](c,i,...g));a[r.assign]=[c]}r.exclude&&(a._excluded[r.assign]=!0),l||(l=a[r.assign])}else if(r.type==="block"){let o=await k(r.instructions,a,i,null);a[r.assign]=o}let f=[];if(l&&Array.isArray(l))for(let r=0;r<l.length;r++){let o={};for(let c in a){if(c==="_excluded"||a._excluded&&a._excluded[c])continue;let u=a[c];o[c]=Array.isArray(u)?u[r]:u}f.push(o)}else f=a;n[e.assign]=f}else if(e.type==="conditional"){let a=!1;try{a=new Function("context","$","return ("+e.condition+");")(n,i)}catch{a=!1}a?await k(e.ifInstructions,n,i,s):e.elseInstructions&&await k(e.elseInstructions,n,i,s)}return n}function b(t){let n={};for(let i of t)for(let s in i)n[s]?n[s]=n[s].concat(i[s]):n[s]=i[s];return n}var O={};function V(t){if(t.engines)for(let n in t.engines)O[n]=t.engines[n];if(t.transformFunctions)for(let n in t.transformFunctions)w[n]=t.transformFunctions[n]}async function _(t,n={}){let i=q(t),{url:s,config:e,instructions:a}=S(t);s=s.replace(/\[(\w+)\]/g,(r,o)=>n[o]!==void 0?encodeURIComponent(n[o]):"");let l={},f=async r=>{let o=T.load(r),c={};return await k(a,c,o,null),L(c,o)};if(e.engine&&e.engine.toLowerCase()==="puppeteer"){let r;try{r=await puppeteer.launch();let o=await r.newPage();if(await o.goto(s,{waitUntil:"networkidle2"}),e.paginationType?.toLowerCase()==="scroll"){let c=[],u=e.paginationLimit?parseInt(e.paginationLimit):5;for(let g=0;g<u;g++){await o.evaluate(()=>window.scrollBy(0,window.innerHeight)),await o.waitForTimeout(1e3);let p=await o.content();c.push(await f(p))}l=b(c)}else if(l=await f(await o.content()),e.paginationNext){let c=1,u=e.paginationLimit?parseInt(e.paginationLimit):5,g=e.paginationNext;for(;c<u;){let p=await o.$(g);if(!p)break;let h=await o.evaluate(m=>m.href,p);await o.goto(h,{waitUntil:"networkidle2"});let d=await f(await o.content());l=b([l,d]),c++}}}finally{r&&await r.close()}return{result:l,config:e}}else{let r=await I(s,i);l=await f(r);let o=T.load(r);if(e.paginationAjax){let c=e.paginationLimit?parseInt(e.paginationLimit):5,u=[];if((e.concurrency?parseInt(e.concurrency):1)>1){let p=Array.from({length:c},(d,m)=>I(e.paginationAjax.replace("{page}",m+1),i)),h=await Promise.all(p);u=await Promise.all(h.map(f))}else for(let p=1;p<=c;p++){let h=await I(e.paginationAjax.replace("{page}",p),i);u.push(await f(h))}l=b(u)}else if(e.paginationNext){let c=1,u=e.paginationLimit?parseInt(e.paginationLimit):5,g=e.paginationNext;for(;c<u;){let p=o(g).first();if(!p||!p.attr("href"))break;let h=new E(p.attr("href"),s).toString(),d=await I(h,i),m=await f(d);l=b([l,m]),c++}}return{result:l,config:e}}}R.exports={scrape:_,parseScript:S,parseInstructions:x,executeInstructions:k,transformFunctions:w,registerPlugin:V};if(y.main===R){let t=U.readFileSync(process.argv[2],"utf8"),n={};if(process.argv.length>3)for(let i=3;i<process.argv.length;i++){let[s,e]=process.argv[i].split("=");n[s]=e}_(t,n).then(i=>{console.log(JSON.stringify(i,null,2))}).catch(i=>{console.error(i)})}});export default B();
//# sourceMappingURL=scengine.mjs.map
