var T=(o=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(o,{get:(t,e)=>(typeof require<"u"?require:t)[e]}):o)(function(o){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+o+'" is not supported')});var $=(o,t)=>()=>(t||o((t={exports:{}}).exports,t),t.exports);var X=$(W=>{"use strict";Object.defineProperty(W,"__esModule",{value:!0});W.LRUCache=void 0;var E=typeof performance=="object"&&performance&&typeof performance.now=="function"?performance:Date,J=new Set,k=typeof process=="object"&&process?process:{},K=(o,t,e,s)=>{typeof k.emitWarning=="function"?k.emitWarning(o,t,e,s):console.error(`[${e}] ${t}: ${o}`)},L=globalThis.AbortController,V=globalThis.AbortSignal,B;if(typeof L>"u"){V=class{onabort;_onabort=[];reason;aborted=!1;addEventListener(s,i){this._onabort.push(i)}},L=class{constructor(){t()}signal=new V;abort(s){var i,n;if(!this.signal.aborted){this.signal.reason=s,this.signal.aborted=!0;for(let r of this.signal._onabort)r(s);(n=(i=this.signal).onabort)==null||n.call(i,s)}}};let o=((B=k.env)==null?void 0:B.LRU_CACHE_IGNORE_AC_WARNING)!=="1",t=()=>{o&&(o=!1,K("AbortController is not defined. If using lru-cache in node 14, load an AbortController polyfill from the `node-abort-controller` package. A minimal polyfill is provided for use by LRUCache.fetch(), but it should not be relied upon in other contexts (eg, passing it to other APIs that use AbortController/AbortSignal might have undesirable effects). You may disable this with LRU_CACHE_IGNORE_AC_WARNING=1 in the env.","NO_ABORT_CONTROLLER","ENOTSUP",t))}}var st=o=>!J.has(o),St=Symbol("type"),F=o=>o&&o===Math.floor(o)&&o>0&&isFinite(o),Y=o=>F(o)?o<=Math.pow(2,8)?Uint8Array:o<=Math.pow(2,16)?Uint16Array:o<=Math.pow(2,32)?Uint32Array:o<=Number.MAX_SAFE_INTEGER?O:null:null,O=class extends Array{constructor(t){super(t),this.fill(0)}},j=class o{heap;length;static#l=!1;static create(t){let e=Y(t);if(!e)return[];o.#l=!0;let s=new o(t,e);return o.#l=!1,s}constructor(t,e){if(!o.#l)throw new TypeError("instantiate Stack using Stack.create(n)");this.heap=new e(t),this.length=0}push(t){this.heap[this.length++]=t}pop(){return this.heap[--this.length]}},P=class o{#l;#f;#p;#m;#R;#v;ttl;ttlResolution;ttlAutopurge;updateAgeOnGet;updateAgeOnHas;allowStale;noDisposeOnSet;noUpdateTTL;maxEntrySize;sizeCalculation;noDeleteOnFetchRejection;noDeleteOnStaleGet;allowStaleOnFetchAbort;allowStaleOnFetchRejection;ignoreFetchAbort;#n;#w;#s;#i;#t;#h;#u;#a;#r;#y;#o;#b;#S;#d;#_;#E;#c;static unsafeExposeInternals(t){return{starts:t.#S,ttls:t.#d,sizes:t.#b,keyMap:t.#s,keyList:t.#i,valList:t.#t,next:t.#h,prev:t.#u,get head(){return t.#a},get tail(){return t.#r},free:t.#y,isBackgroundFetch:e=>t.#e(e),backgroundFetch:(e,s,i,n)=>t.#I(e,s,i,n),moveToTail:e=>t.#z(e),indexes:e=>t.#A(e),rindexes:e=>t.#x(e),isStale:e=>t.#g(e)}}get max(){return this.#l}get maxSize(){return this.#f}get calculatedSize(){return this.#w}get size(){return this.#n}get fetchMethod(){return this.#R}get memoMethod(){return this.#v}get dispose(){return this.#p}get disposeAfter(){return this.#m}constructor(t){let{max:e=0,ttl:s,ttlResolution:i=1,ttlAutopurge:n,updateAgeOnGet:r,updateAgeOnHas:l,allowStale:a,dispose:h,disposeAfter:f,noDisposeOnSet:c,noUpdateTTL:m,maxSize:w=0,maxEntrySize:g=0,sizeCalculation:d,fetchMethod:p,memoMethod:u,noDeleteOnFetchRejection:y,noDeleteOnStaleGet:S,allowStaleOnFetchRejection:b,allowStaleOnFetchAbort:_,ignoreFetchAbort:C}=t;if(e!==0&&!F(e))throw new TypeError("max option must be a nonnegative integer");let x=e?Y(e):Array;if(!x)throw new Error("invalid max value: "+e);if(this.#l=e,this.#f=w,this.maxEntrySize=g||this.#f,this.sizeCalculation=d,this.sizeCalculation){if(!this.#f&&!this.maxEntrySize)throw new TypeError("cannot set sizeCalculation without setting maxSize or maxEntrySize");if(typeof this.sizeCalculation!="function")throw new TypeError("sizeCalculation set to non-function")}if(u!==void 0&&typeof u!="function")throw new TypeError("memoMethod must be a function if defined");if(this.#v=u,p!==void 0&&typeof p!="function")throw new TypeError("fetchMethod must be a function if specified");if(this.#R=p,this.#E=!!p,this.#s=new Map,this.#i=new Array(e).fill(void 0),this.#t=new Array(e).fill(void 0),this.#h=new x(e),this.#u=new x(e),this.#a=0,this.#r=0,this.#y=j.create(e),this.#n=0,this.#w=0,typeof h=="function"&&(this.#p=h),typeof f=="function"?(this.#m=f,this.#o=[]):(this.#m=void 0,this.#o=void 0),this.#_=!!this.#p,this.#c=!!this.#m,this.noDisposeOnSet=!!c,this.noUpdateTTL=!!m,this.noDeleteOnFetchRejection=!!y,this.allowStaleOnFetchRejection=!!b,this.allowStaleOnFetchAbort=!!_,this.ignoreFetchAbort=!!C,this.maxEntrySize!==0){if(this.#f!==0&&!F(this.#f))throw new TypeError("maxSize must be a positive integer if specified");if(!F(this.maxEntrySize))throw new TypeError("maxEntrySize must be a positive integer if specified");this.#N()}if(this.allowStale=!!a,this.noDeleteOnStaleGet=!!S,this.updateAgeOnGet=!!r,this.updateAgeOnHas=!!l,this.ttlResolution=F(i)||i===0?i:1,this.ttlAutopurge=!!n,this.ttl=s||0,this.ttl){if(!F(this.ttl))throw new TypeError("ttl must be a positive integer if specified");this.#D()}if(this.#l===0&&this.ttl===0&&this.#f===0)throw new TypeError("At least one of max, maxSize, or ttl is required");if(!this.ttlAutopurge&&!this.#l&&!this.#f){let v="LRU_CACHE_UNBOUNDED";st(v)&&(J.add(v),K("TTL caching without ttlAutopurge, max, or maxSize can result in unbounded memory consumption.","UnboundedCacheWarning",v,o))}}getRemainingTTL(t){return this.#s.has(t)?1/0:0}#D(){let t=new O(this.#l),e=new O(this.#l);this.#d=t,this.#S=e,this.#U=(n,r,l=E.now())=>{if(e[n]=r!==0?l:0,t[n]=r,r!==0&&this.ttlAutopurge){let a=setTimeout(()=>{this.#g(n)&&this.#T(this.#i[n],"expire")},r+1);a.unref&&a.unref()}},this.#O=n=>{e[n]=t[n]!==0?E.now():0},this.#F=(n,r)=>{if(t[r]){let l=t[r],a=e[r];if(!l||!a)return;n.ttl=l,n.start=a,n.now=s||i();let h=n.now-a;n.remainingTTL=l-h}};let s=0,i=()=>{let n=E.now();if(this.ttlResolution>0){s=n;let r=setTimeout(()=>s=0,this.ttlResolution);r.unref&&r.unref()}return n};this.getRemainingTTL=n=>{let r=this.#s.get(n);if(r===void 0)return 0;let l=t[r],a=e[r];if(!l||!a)return 1/0;let h=(s||i())-a;return l-h},this.#g=n=>{let r=e[n],l=t[n];return!!l&&!!r&&(s||i())-r>l}}#O=()=>{};#F=()=>{};#U=()=>{};#g=()=>!1;#N(){let t=new O(this.#l);this.#w=0,this.#b=t,this.#C=e=>{this.#w-=t[e],t[e]=0},this.#k=(e,s,i,n)=>{if(this.#e(s))return 0;if(!F(i))if(n){if(typeof n!="function")throw new TypeError("sizeCalculation must be a function");if(i=n(s,e),!F(i))throw new TypeError("sizeCalculation return invalid (expect positive integer)")}else throw new TypeError("invalid size value (must be positive integer). When maxSize or maxEntrySize is used, sizeCalculation or size must be set.");return i},this.#L=(e,s,i)=>{if(t[e]=s,this.#f){let n=this.#f-t[e];for(;this.#w>n;)this.#W(!0)}this.#w+=t[e],i&&(i.entrySize=s,i.totalCalculatedSize=this.#w)}}#C=t=>{};#L=(t,e,s)=>{};#k=(t,e,s,i)=>{if(s||i)throw new TypeError("cannot set size without setting maxSize or maxEntrySize on cache");return 0};*#A({allowStale:t=this.allowStale}={}){if(this.#n)for(let e=this.#r;!(!this.#j(e)||((t||!this.#g(e))&&(yield e),e===this.#a));)e=this.#u[e]}*#x({allowStale:t=this.allowStale}={}){if(this.#n)for(let e=this.#a;!(!this.#j(e)||((t||!this.#g(e))&&(yield e),e===this.#r));)e=this.#h[e]}#j(t){return t!==void 0&&this.#s.get(this.#i[t])===t}*entries(){for(let t of this.#A())this.#t[t]!==void 0&&this.#i[t]!==void 0&&!this.#e(this.#t[t])&&(yield[this.#i[t],this.#t[t]])}*rentries(){for(let t of this.#x())this.#t[t]!==void 0&&this.#i[t]!==void 0&&!this.#e(this.#t[t])&&(yield[this.#i[t],this.#t[t]])}*keys(){for(let t of this.#A()){let e=this.#i[t];e!==void 0&&!this.#e(this.#t[t])&&(yield e)}}*rkeys(){for(let t of this.#x()){let e=this.#i[t];e!==void 0&&!this.#e(this.#t[t])&&(yield e)}}*values(){for(let t of this.#A())this.#t[t]!==void 0&&!this.#e(this.#t[t])&&(yield this.#t[t])}*rvalues(){for(let t of this.#x())this.#t[t]!==void 0&&!this.#e(this.#t[t])&&(yield this.#t[t])}[Symbol.iterator](){return this.entries()}[Symbol.toStringTag]="LRUCache";find(t,e={}){for(let s of this.#A()){let i=this.#t[s],n=this.#e(i)?i.__staleWhileFetching:i;if(n!==void 0&&t(n,this.#i[s],this))return this.get(this.#i[s],e)}}forEach(t,e=this){for(let s of this.#A()){let i=this.#t[s],n=this.#e(i)?i.__staleWhileFetching:i;n!==void 0&&t.call(e,n,this.#i[s],this)}}rforEach(t,e=this){for(let s of this.#x()){let i=this.#t[s],n=this.#e(i)?i.__staleWhileFetching:i;n!==void 0&&t.call(e,n,this.#i[s],this)}}purgeStale(){let t=!1;for(let e of this.#x({allowStale:!0}))this.#g(e)&&(this.#T(this.#i[e],"expire"),t=!0);return t}info(t){let e=this.#s.get(t);if(e===void 0)return;let s=this.#t[e],i=this.#e(s)?s.__staleWhileFetching:s;if(i===void 0)return;let n={value:i};if(this.#d&&this.#S){let r=this.#d[e],l=this.#S[e];if(r&&l){let a=r-(E.now()-l);n.ttl=a,n.start=Date.now()}}return this.#b&&(n.size=this.#b[e]),n}dump(){let t=[];for(let e of this.#A({allowStale:!0})){let s=this.#i[e],i=this.#t[e],n=this.#e(i)?i.__staleWhileFetching:i;if(n===void 0||s===void 0)continue;let r={value:n};if(this.#d&&this.#S){r.ttl=this.#d[e];let l=E.now()-this.#S[e];r.start=Math.floor(Date.now()-l)}this.#b&&(r.size=this.#b[e]),t.unshift([s,r])}return t}load(t){this.clear();for(let[e,s]of t){if(s.start){let i=Date.now()-s.start;s.start=E.now()-i}this.set(e,s.value,s)}}set(t,e,s={}){var m,w,g,d,p;if(e===void 0)return this.delete(t),this;let{ttl:i=this.ttl,start:n,noDisposeOnSet:r=this.noDisposeOnSet,sizeCalculation:l=this.sizeCalculation,status:a}=s,{noUpdateTTL:h=this.noUpdateTTL}=s,f=this.#k(t,e,s.size||0,l);if(this.maxEntrySize&&f>this.maxEntrySize)return a&&(a.set="miss",a.maxEntrySizeExceeded=!0),this.#T(t,"set"),this;let c=this.#n===0?void 0:this.#s.get(t);if(c===void 0)c=this.#n===0?this.#r:this.#y.length!==0?this.#y.pop():this.#n===this.#l?this.#W(!1):this.#n,this.#i[c]=t,this.#t[c]=e,this.#s.set(t,c),this.#h[this.#r]=c,this.#u[c]=this.#r,this.#r=c,this.#n++,this.#L(c,f,a),a&&(a.set="add"),h=!1;else{this.#z(c);let u=this.#t[c];if(e!==u){if(this.#E&&this.#e(u)){u.__abortController.abort(new Error("replaced"));let{__staleWhileFetching:y}=u;y!==void 0&&!r&&(this.#_&&((m=this.#p)==null||m.call(this,y,t,"set")),this.#c&&((w=this.#o)==null||w.push([y,t,"set"])))}else r||(this.#_&&((g=this.#p)==null||g.call(this,u,t,"set")),this.#c&&((d=this.#o)==null||d.push([u,t,"set"])));if(this.#C(c),this.#L(c,f,a),this.#t[c]=e,a){a.set="replace";let y=u&&this.#e(u)?u.__staleWhileFetching:u;y!==void 0&&(a.oldValue=y)}}else a&&(a.set="update")}if(i!==0&&!this.#d&&this.#D(),this.#d&&(h||this.#U(c,i,n),a&&this.#F(a,c)),!r&&this.#c&&this.#o){let u=this.#o,y;for(;y=u==null?void 0:u.shift();)(p=this.#m)==null||p.call(this,...y)}return this}pop(){var t;try{for(;this.#n;){let e=this.#t[this.#a];if(this.#W(!0),this.#e(e)){if(e.__staleWhileFetching)return e.__staleWhileFetching}else if(e!==void 0)return e}}finally{if(this.#c&&this.#o){let e=this.#o,s;for(;s=e==null?void 0:e.shift();)(t=this.#m)==null||t.call(this,...s)}}}#W(t){var n,r;let e=this.#a,s=this.#i[e],i=this.#t[e];return this.#E&&this.#e(i)?i.__abortController.abort(new Error("evicted")):(this.#_||this.#c)&&(this.#_&&((n=this.#p)==null||n.call(this,i,s,"evict")),this.#c&&((r=this.#o)==null||r.push([i,s,"evict"]))),this.#C(e),t&&(this.#i[e]=void 0,this.#t[e]=void 0,this.#y.push(e)),this.#n===1?(this.#a=this.#r=0,this.#y.length=0):this.#a=this.#h[e],this.#s.delete(s),this.#n--,e}has(t,e={}){let{updateAgeOnHas:s=this.updateAgeOnHas,status:i}=e,n=this.#s.get(t);if(n!==void 0){let r=this.#t[n];if(this.#e(r)&&r.__staleWhileFetching===void 0)return!1;if(this.#g(n))i&&(i.has="stale",this.#F(i,n));else return s&&this.#O(n),i&&(i.has="hit",this.#F(i,n)),!0}else i&&(i.has="miss");return!1}peek(t,e={}){let{allowStale:s=this.allowStale}=e,i=this.#s.get(t);if(i===void 0||!s&&this.#g(i))return;let n=this.#t[i];return this.#e(n)?n.__staleWhileFetching:n}#I(t,e,s,i){let n=e===void 0?void 0:this.#t[e];if(this.#e(n))return n;let r=new L,{signal:l}=s;l==null||l.addEventListener("abort",()=>r.abort(l.reason),{signal:r.signal});let a={signal:r.signal,options:s,context:i},h=(d,p=!1)=>{let{aborted:u}=r.signal,y=s.ignoreFetchAbort&&d!==void 0;if(s.status&&(u&&!p?(s.status.fetchAborted=!0,s.status.fetchError=r.signal.reason,y&&(s.status.fetchAbortIgnored=!0)):s.status.fetchResolved=!0),u&&!y&&!p)return c(r.signal.reason);let S=w;return this.#t[e]===w&&(d===void 0?S.__staleWhileFetching?this.#t[e]=S.__staleWhileFetching:this.#T(t,"fetch"):(s.status&&(s.status.fetchUpdated=!0),this.set(t,d,a.options))),d},f=d=>(s.status&&(s.status.fetchRejected=!0,s.status.fetchError=d),c(d)),c=d=>{let{aborted:p}=r.signal,u=p&&s.allowStaleOnFetchAbort,y=u||s.allowStaleOnFetchRejection,S=y||s.noDeleteOnFetchRejection,b=w;if(this.#t[e]===w&&(!S||b.__staleWhileFetching===void 0?this.#T(t,"fetch"):u||(this.#t[e]=b.__staleWhileFetching)),y)return s.status&&b.__staleWhileFetching!==void 0&&(s.status.returnedStale=!0),b.__staleWhileFetching;if(b.__returned===b)throw d},m=(d,p)=>{var y;let u=(y=this.#R)==null?void 0:y.call(this,t,n,a);u&&u instanceof Promise&&u.then(S=>d(S===void 0?void 0:S),p),r.signal.addEventListener("abort",()=>{(!s.ignoreFetchAbort||s.allowStaleOnFetchAbort)&&(d(void 0),s.allowStaleOnFetchAbort&&(d=S=>h(S,!0)))})};s.status&&(s.status.fetchDispatched=!0);let w=new Promise(m).then(h,f),g=Object.assign(w,{__abortController:r,__staleWhileFetching:n,__returned:void 0});return e===void 0?(this.set(t,g,{...a.options,status:void 0}),e=this.#s.get(t)):this.#t[e]=g,g}#e(t){if(!this.#E)return!1;let e=t;return!!e&&e instanceof Promise&&e.hasOwnProperty("__staleWhileFetching")&&e.__abortController instanceof L}async fetch(t,e={}){let{allowStale:s=this.allowStale,updateAgeOnGet:i=this.updateAgeOnGet,noDeleteOnStaleGet:n=this.noDeleteOnStaleGet,ttl:r=this.ttl,noDisposeOnSet:l=this.noDisposeOnSet,size:a=0,sizeCalculation:h=this.sizeCalculation,noUpdateTTL:f=this.noUpdateTTL,noDeleteOnFetchRejection:c=this.noDeleteOnFetchRejection,allowStaleOnFetchRejection:m=this.allowStaleOnFetchRejection,ignoreFetchAbort:w=this.ignoreFetchAbort,allowStaleOnFetchAbort:g=this.allowStaleOnFetchAbort,context:d,forceRefresh:p=!1,status:u,signal:y}=e;if(!this.#E)return u&&(u.fetch="get"),this.get(t,{allowStale:s,updateAgeOnGet:i,noDeleteOnStaleGet:n,status:u});let S={allowStale:s,updateAgeOnGet:i,noDeleteOnStaleGet:n,ttl:r,noDisposeOnSet:l,size:a,sizeCalculation:h,noUpdateTTL:f,noDeleteOnFetchRejection:c,allowStaleOnFetchRejection:m,allowStaleOnFetchAbort:g,ignoreFetchAbort:w,status:u,signal:y},b=this.#s.get(t);if(b===void 0){u&&(u.fetch="miss");let _=this.#I(t,b,S,d);return _.__returned=_}else{let _=this.#t[b];if(this.#e(_)){let q=s&&_.__staleWhileFetching!==void 0;return u&&(u.fetch="inflight",q&&(u.returnedStale=!0)),q?_.__staleWhileFetching:_.__returned=_}let C=this.#g(b);if(!p&&!C)return u&&(u.fetch="hit"),this.#z(b),i&&this.#O(b),u&&this.#F(u,b),_;let x=this.#I(t,b,S,d),U=x.__staleWhileFetching!==void 0&&s;return u&&(u.fetch=C?"stale":"refresh",U&&C&&(u.returnedStale=!0)),U?x.__staleWhileFetching:x.__returned=x}}async forceFetch(t,e={}){let s=await this.fetch(t,e);if(s===void 0)throw new Error("fetch() returned undefined");return s}memo(t,e={}){let s=this.#v;if(!s)throw new Error("no memoMethod provided to constructor");let{context:i,forceRefresh:n,...r}=e,l=this.get(t,r);if(!n&&l!==void 0)return l;let a=s(t,l,{options:r,context:i});return this.set(t,a,r),a}get(t,e={}){let{allowStale:s=this.allowStale,updateAgeOnGet:i=this.updateAgeOnGet,noDeleteOnStaleGet:n=this.noDeleteOnStaleGet,status:r}=e,l=this.#s.get(t);if(l!==void 0){let a=this.#t[l],h=this.#e(a);return r&&this.#F(r,l),this.#g(l)?(r&&(r.get="stale"),h?(r&&s&&a.__staleWhileFetching!==void 0&&(r.returnedStale=!0),s?a.__staleWhileFetching:void 0):(n||this.#T(t,"expire"),r&&s&&(r.returnedStale=!0),s?a:void 0)):(r&&(r.get="hit"),h?a.__staleWhileFetching:(this.#z(l),i&&this.#O(l),a))}else r&&(r.get="miss")}#P(t,e){this.#u[e]=t,this.#h[t]=e}#z(t){t!==this.#r&&(t===this.#a?this.#a=this.#h[t]:this.#P(this.#u[t],this.#h[t]),this.#P(this.#r,t),this.#r=t)}delete(t){return this.#T(t,"delete")}#T(t,e){var i,n,r,l;let s=!1;if(this.#n!==0){let a=this.#s.get(t);if(a!==void 0)if(s=!0,this.#n===1)this.#M(e);else{this.#C(a);let h=this.#t[a];if(this.#e(h)?h.__abortController.abort(new Error("deleted")):(this.#_||this.#c)&&(this.#_&&((i=this.#p)==null||i.call(this,h,t,e)),this.#c&&((n=this.#o)==null||n.push([h,t,e]))),this.#s.delete(t),this.#i[a]=void 0,this.#t[a]=void 0,a===this.#r)this.#r=this.#u[a];else if(a===this.#a)this.#a=this.#h[a];else{let f=this.#u[a];this.#h[f]=this.#h[a];let c=this.#h[a];this.#u[c]=this.#u[a]}this.#n--,this.#y.push(a)}}if(this.#c&&((r=this.#o)!=null&&r.length)){let a=this.#o,h;for(;h=a==null?void 0:a.shift();)(l=this.#m)==null||l.call(this,...h)}return s}clear(){return this.#M("delete")}#M(t){var e,s,i;for(let n of this.#x({allowStale:!0})){let r=this.#t[n];if(this.#e(r))r.__abortController.abort(new Error("deleted"));else{let l=this.#i[n];this.#_&&((e=this.#p)==null||e.call(this,r,l,t)),this.#c&&((s=this.#o)==null||s.push([r,l,t]))}}if(this.#s.clear(),this.#t.fill(void 0),this.#i.fill(void 0),this.#d&&this.#S&&(this.#d.fill(0),this.#S.fill(0)),this.#b&&this.#b.fill(0),this.#a=0,this.#r=0,this.#y.length=0,this.#w=0,this.#n=0,this.#c&&this.#o){let n=this.#o,r;for(;r=n==null?void 0:n.shift();)(i=this.#m)==null||i.call(this,...r)}}};W.LRUCache=P});var mt=$((At,H)=>{var nt=T("axios"),rt=T("fs"),Q=T("cheerio"),{URL:ot}=T("url"),at=T("puppeteer"),{LRUCache:lt}=X(),ht=T("crypto"),G=1e3*60*5,tt=new lt({max:100,ttl:G}),Z=new Map;function ct(o){return tt.get(o)}function ft(o,t,e=G){tt.set(o,t,{ttl:e})}function ut(o){return ht.createHash("md5").update(o).digest("hex")}function dt(o,t){return`${o}::${t}`}async function I(o,t,e={},s=G){let i=dt(o,t),n=ct(i);if(n)return n;let r=await nt.get(o,e);return ft(i,r.data,s),r.data}var A={trim:(o,t)=>typeof o=="string"?o.trim():o,toLowerCase:(o,t)=>typeof o=="string"?o.toLowerCase():o,toUpperCase:(o,t)=>typeof o=="string"?o.toUpperCase():o,default:(o,t,e)=>o==null||o===""?e:o,regex:(o,t,e,s="0")=>{if(typeof o!="string")return o;let i=new RegExp(e),n=o.match(i);if(n){let r=parseInt(s);return n[r]||o}return o},dateParse:(o,t)=>{let e=new Date(o);return isNaN(e.getTime())?o:e.toISOString()},customJS:(o,t,e)=>{try{return new Function("value",e)(o)}catch{return o}},regexReplace:(o,t,e,s)=>{if(typeof o!="string")return o;e=e.replace(/\\\\/g,"\\");let i=Z.get(e);return i||(i=new RegExp(e),Z.set(e,i)),o.replace(i,s)}};function N(o,t){if(Array.isArray(o))return o.map(e=>N(e,t));if(typeof o=="object"&&o!==null){if(o.type&&o.children)return t(o).text();let e={};for(let s in o)e[s]=N(o[s],t);return e}else return o}function M(o,t){let e=[],s=1,i=t;for(;i<o.length&&s>0;){let n=o[i];n.endsWith("{")?(s++,e.push(n)):n==="}"?(s--,s>0&&e.push(n)):e.push(n),i++}return{blockText:e.join(`
`),newIndex:i}}function et(o){o=o.trim();let t=o.match(/^([^\{]+)\{([\s\S]+)\}\s*$/);if(!t)throw new Error("Invalid script format. Ensure the Scengine is enclosed in { }.");let e=t[1].trim().split("|").map(l=>l.trim()),s=e[0],i={};for(let l=1;l<e.length;l++){let[a,h]=e[l].split("=");a&&h&&(i[a.trim()]=h.trim())}let n=t[2].trim(),r=z(n);return{url:s,config:i,instructions:r}}function z(o){o=o.replace(/}\s*else\s*{/g,`}
else {`);let t=o.split(`
`).map(i=>i.trim()).filter(i=>i&&!i.startsWith("//")),e=[],s=0;for(;s<t.length;){let i=t[s];if(/^if\s*\(.*\)\s*\{$/.test(i)){let n=i.match(/^if\s*\((.*)\)\s*\{$/);if(!n)throw new Error(`Invalid if condition: ${i}`);let r=n[1];s++;let{blockText:l,newIndex:a}=M(t,s),h=z(l);s=a;let f=null;if(s<t.length&&/^else\s*\{$/.test(t[s])){s++;let{blockText:c,newIndex:m}=M(t,s);f=z(c),s=m}e.push({type:"conditional",condition:r,ifInstructions:h,elseInstructions:f});continue}if(i.endsWith(":{")){let n=i.slice(0,-2).trim();s++;let{blockText:r,newIndex:l}=M(t,s),a=z(r);e.push({type:"block",assign:n,instructions:a}),s=l;continue}{let n=!1;i.startsWith("!")&&(n=!0,i=i.slice(1).trim());let r=i.split("=");if(r.length!==2)throw new Error(`Invalid instruction: ${i}`);let l=r[0].trim(),a=r[1].trim(),h,f=[];if(a.includes("|")){let g=a.split("|").map(d=>d.trim());h=g[0],f=g.slice(1).map(d=>{let p=d.match(/^(\w+)(?:\((.*)\))?$/);return p?{fn:p[1],params:p[2]?p[2].split(",").map(u=>u.trim().replace(/^["']|["']$/g,"")):[]}:{fn:d,params:[]}})}else h=a;let c=null;(l.startsWith('"')&&l.endsWith('"')||l.startsWith("'")&&l.endsWith("'"))&&(c=l.slice(1,-1));let m=null,w=null;if(!c){let g=l.split(">").map(p=>p.trim());m=g.map(p=>p.includes("..")?p.replace(/\.\./g,"."):p);let d=g[g.length-1];if(!d.startsWith(".")&&d.includes(".")){let p=d.split(".");m[m.length-1]=p[0].trim(),w=p[1].trim()}}c!==null?e.push({type:"literal",literal:c,assign:h,transforms:f,exclude:n}):e.push({type:"extract",exclude:n,chain:m,attribute:w,assign:h,transforms:f}),s++}}return e}async function R(o,t,e,s){t._excluded||(t._excluded={});for(let i of o)if(i.type==="extract"){let n=i.chain[0],r;s?r=s:t[n]?r=t[n]:r=e(n).toArray();for(let l=1;l<i.chain.length;l++){let a=i.chain[l],h=[];for(let f of r)h=h.concat(e(f).find(a).toArray());r=h}i.attribute&&(r=r.map(l=>e(l).attr(i.attribute))),i.transforms&&i.transforms.length>0&&(r=r.map(l=>{let a=l;for(let{fn:h,params:f}of i.transforms)typeof A[h]=="function"&&(a=A[h](a,e,...f));return a})),t[i.assign]=r,i.exclude&&(t._excluded[i.assign]=!0)}else if(i.type==="literal"){let n=i.literal;if(i.transforms&&i.transforms.length>0)for(let{fn:r,params:l}of i.transforms)typeof A[r]=="function"&&(n=A[r](n,e,...l));t[i.assign]=[n],i.exclude&&(t._excluded[i.assign]=!0)}else if(i.type==="block"){let n={};n._excluded={};let r=null;for(let a of i.instructions)if(a.type==="extract"||a.type==="literal"){let h;if(a.type==="extract"){let f=a.chain[0];n[f]?h=n[f]:t[f]?h=t[f]:h=e(f).toArray();for(let c=1;c<a.chain.length;c++){let m=a.chain[c],w=[];for(let g of h)w=w.concat(e(g).find(m).toArray());h=w}a.attribute&&(h=h.map(c=>e(c).attr(a.attribute))),a.transforms&&a.transforms.length>0&&(h=h.map(c=>{let m=c;for(let{fn:w,params:g}of a.transforms)typeof A[w]=="function"&&(m=A[w](m,e,...g));return m})),n[a.assign]=h}else if(a.type==="literal"){let f=a.literal;if(a.transforms&&a.transforms.length>0)for(let{fn:c,params:m}of a.transforms)typeof A[c]=="function"&&(f=A[c](f,e,...m));n[a.assign]=[f]}a.exclude&&(n._excluded[a.assign]=!0),r||(r=n[a.assign])}else if(a.type==="block"){let h=await R(a.instructions,n,e,null);n[a.assign]=h}let l=[];if(r&&Array.isArray(r))for(let a=0;a<r.length;a++){let h={};for(let f in n){if(f==="_excluded"||n._excluded&&n._excluded[f])continue;let c=n[f];h[f]=Array.isArray(c)?c[a]:c}l.push(h)}else l=n;t[i.assign]=l}else if(i.type==="conditional"){let n=!1;try{n=new Function("context","$","return ("+i.condition+");")(t,e)}catch{n=!1}n?await R(i.ifInstructions,t,e,s):i.elseInstructions&&await R(i.elseInstructions,t,e,s)}return t}function D(o){let t={};for(let e of o)for(let s in e){if(s==="_excluded"){t._excluded||(t._excluded={}),Object.assign(t._excluded,e._excluded);continue}Array.isArray(e[s])?(t[s]||(t[s]=[]),t[s]=t[s].concat(e[s])):(t[s]||(t[s]=[]),t[s].push(e[s]))}return t}var gt={};function pt(o){if(o.engines)for(let t in o.engines)gt[t]=o.engines[t];if(o.transformFunctions)for(let t in o.transformFunctions)A[t]=o.transformFunctions[t]}async function it(o,t={}){var a;let e=ut(o),{url:s,config:i,instructions:n}=et(o);s=s.replace(/\[(\w+)\]/g,(h,f)=>t[f]!==void 0?encodeURIComponent(t[f]):"");let r={},l=async h=>{let f=Q.load(h),c={};return await R(n,c,f,null),N(c,f)};if(i.engine&&i.engine.toLowerCase()==="puppeteer"){let h;try{h=await at.launch();let f=await h.newPage();if(await f.goto(s,{waitUntil:"networkidle2"}),((a=i.paginationType)==null?void 0:a.toLowerCase())==="scroll"){let c=[],m=i.paginationLimit?parseInt(i.paginationLimit):5;for(let w=0;w<m;w++){await f.evaluate(()=>window.scrollBy(0,window.innerHeight)),await f.waitForTimeout(1e3);let g=await f.content();c.push(await l(g))}r=D(c)}else if(r=await l(await f.content()),i.paginationNext){let c=1,m=i.paginationLimit?parseInt(i.paginationLimit):5,w=i.paginationNext;for(;c<m;){let g=await f.$(w);if(!g)break;let d=await f.evaluate(u=>u.href,g);await f.goto(d,{waitUntil:"networkidle2"});let p=await l(await f.content());r=D([r,p]),c++}}}finally{h&&await h.close()}return{result:r,config:i}}else{let h=await I(s,e);r=await l(h);let f=Q.load(h);if(i.paginationAjax){let c=i.paginationLimit?parseInt(i.paginationLimit):5,m=[];if((i.concurrency?parseInt(i.concurrency):1)>1){let g=Array.from({length:c},(p,u)=>I(i.paginationAjax.replace("{page}",u+1),e)),d=await Promise.all(g);m=await Promise.all(d.map(l))}else for(let g=1;g<=c;g++){let d=await I(i.paginationAjax.replace("{page}",g),e);m.push(await l(d))}r=D(m)}else if(i.paginationNext){let c=1,m=i.paginationLimit?parseInt(i.paginationLimit):5,w=i.paginationNext;for(;c<m;){let g=f(w).first();if(!g||!g.attr("href"))break;let d=new ot(g.attr("href"),s).toString(),p=await I(d,e),u=await l(p);r=D([r,u]),c++}}return{result:r,config:i}}}H.exports={scrape:it,parseScript:et,parseInstructions:z,executeInstructions:R,transformFunctions:A,registerPlugin:pt};if(T.main===H){process.argv.length<3&&(console.error("Usage: node index.js <script_file> [prop1=val1 prop2=val2 ...]"),process.exit(1));let o=rt.readFileSync(process.argv[2],"utf8"),t={};if(process.argv.length>3)for(let e=3;e<process.argv.length;e++){let[s,i]=process.argv[e].split("=");t[s]=i}it(o,t).then(e=>{console.log(JSON.stringify(e,null,2))}).catch(e=>{console.error(e)})}});export default mt();
//# sourceMappingURL=scengine.mjs.map
